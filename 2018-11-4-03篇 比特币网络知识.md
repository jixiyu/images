> 链-比特币  
> 2018年11月04日 11时44分13秒  
> 03 篇  

### 比特币网络(bitcoin network) 

###### 1. p2p网络架构

 1. 比特币采用了基于国际互联网（Internet）的P2P（peer-to-peer）网络架构。

 2. P2P是指位于同一网络中的每台计算机都彼此对等，各个节点共同提供网络服务，不存在任何“特殊”节点。
 3. 每个网络节点以“扁平（flat）”的拓扑结构相互连通。 在P2P网络中不存在任何服务端（server）、中央化的服务、以及层级结构。P2P网络的节点之间交互运作、协同处理：每个节点在对外提供服务的同时也使用网络中其他节点所提供的服务。P2P网络也因此具有可靠性、去中心化，以 及开放性。
 4. 拓扑的含义，所谓“拓扑”就是**把实体抽象成与其大小、形状无关的“点”**，而把连接实体的线路抽象成“线”，**进而以图的形式来表示这些点与线之间关系的方法**，其目的在于研究这些点、线之间的相连关系。表示点和线之间关系的图被称为拓扑结构图。拓扑结构与几何结构属于两个不同的数学概念。
 5. 去中心化控制是设计时的核心原则，它只能通过维持一种扁平化、去中心化的**P2P共识网络**来实现。


###### 2. 节点类型及角色  
1. 尽管比特币P2P网络中的各个节点相互对等，**但是根据所提供的功能不同，各节点可能具有不同的角色**。每个比特币节点都是 **路由、区块链数据库、挖矿、钱包服务的功能集合** 。
2. 全节点（full node）:具有所有四个功能：钱包，矿工，完整的区块链数据库和网络路由  

    <img src="https://www.github.com/jixiyu/images3/raw/master/小书匠/1541306514457.png" width="300" hegiht="313" align="center" />  
    
      
      

3. 每个节点都参与全网络的路由功能,每个节点都参与验证并传播交易及区块信息，发现并维持与对等节点的连接。
4.  一些节点保有一份完整的、最新的区块链拷贝，这样的节点被称为“全节点”。**全节点能够独立自主地校验所有交易，而不需借由任何外部参照。**
5.  另外还有一些节点只保留了区块链的一部分，它们通过一种名为 **“简易支付验证（SPV）”的方 式来完成交易验证。这样的节点被称为“SPV节点”，又叫“轻量级节点”。**
6.  SPV节点没有此蓝色圆圈，以示它们没有区块链的完整拷贝。
7.  挖矿节点通过运行在特殊硬件设备上的工作量证明（proof-of-work）算法，以相互竞争的方式创建新的区块。**一些挖矿 节点同时也是全节点，保有区块链的完整拷贝；**
8.  **还有一些参与矿池挖矿的节点是轻量级节点**，它们必须**依赖矿池服务器维护的全节点**进行工作。在全节点用例中，挖矿功能如图中名为“矿工”的黑色圆圈字母“M”所示。

<img src="https://www.github.com/jixiyu/images3/raw/master/小书匠/1541307410049.png" width="500" hegiht="900" align="center" />    


##### 3.扩展比特币网络
1. 运行比特币P2P协议的比特币主网络由大约5000-8000个运行着不同版本比特币核心客户端（Bitcoin Core）的监听节 点、以及几百个运行着各类比特币P2P协议的应用（例如Bitcoin Classic, Bitcoin Unlimited, BitcoinJ, Libbitcoin, btcd, and bcoin等）的节点组成。
2. 许多连接到比特币网络的大型公司运行 着基于Bitcoin核心客户端的全节点客户端，它们具有区块链的完整拷贝及网络节点，但不具备挖矿及钱包功能。这些节点是网络中的边缘路由器（edge  routers），通过它们可以搭建其他服务，例如交易所、钱包、区块浏览器、商家支付处理（merchant payment processing）等。


      <img src="https://www.github.com/jixiyu/images3/raw/master/小书匠/1541309652807.png" width="500" hegiht="1200" align="center" />    

##### 4. 比特币传播网络
1. 虽然比特币P2P网络服务于各种各样的节点类型的一般需求，但是对于比特币挖掘节点的专门需求，它显示出太高的网络延迟。
2. 在参加比赛时，比特币矿工必须最大限度地缩短获胜块的传播与下一轮比赛开始之间的时间。在采矿方面，网络延迟与利润率直接相关。
3. 比特币传播网络是一种尝试最小化矿工之间传输块的延迟的网络。原始的比特币传播网络是由核心开发商Matt Corallo于2015年创建的，以便能够以非常低的延迟在矿工之间快速同步块。该网络由世界各地的亚马逊Web服务基础架构上托管的几个专门的节点组成，并且连接大多数矿工和采矿池。
4. 原始的比特币传播网络在2016年被替换为**Fast Internet Bitcoin Relay Engine or FIBRE**，也由核心开发商Matt Corallo创建。 FIBER是一种基于UDP的中继网络，可以中继节点网络内的块。 FIBER实现了compact block，**以进一步减少传输的数据量和网络延迟**。
5. 康奈尔大学研究的另一个中继网络（仍在提案阶段）是 Falcon。 Falcon使用“直通路由”而不是“存储转发”来减少延迟，通过传播块的部分，而不是等待直到接收到完整的块。
6. **传播网络不是比特币的P2P网络的替代品。相反，它们是覆盖网络**，在具有特殊需求的节点之间提供额外的连接像高速公路不是农村道路的替代品，而是交通繁忙的两点之间的快捷方式，您仍然需要小路连接高速公路。

##### 5. 网络发现
1. 当新的网络节点启动后，为了能够参与协同运作，它必须发现网络中的其他比特币节点。新的网络节点必须发现至少一个网络中存在的节点并建立连接。
2. 由于比特币网络的拓扑结构并不基于节点间的地理位置，因此各个节点之间的地理信息完全无关。在新节点连接时，可以随机选择网络中存在的比特币节点与之相连。
3. 节点通常采用TCP协议、使用8333端口（该端口号通常是比特币所使用的，除8333端口外也可以指定使用其他端口） 与已知的对等节点建立连接。
4. 在建立连接时，该节点会通过发送一条包含基本认证内容的version消息开始“握手”通信过 程。这一过程包括如下内容：
- ▷ nVersion 定义了客户端所“说出”的比特币P2P协议所采用的版本（例如：70002）。

- ▷ nLocalServices 一组该节点支持的本地服务列表，当前仅支持NODE_NETWORK

- ▷ nTime 当前时间

- ▷ addrYou 当前节点可见的远程节点的IP地址

- ▷ addrMe 本地节点所发现的本机IP地址

- ▷ subver 指示当前节点运行的软件类型的子版本号（例如：”/Satoshi:0.9.2.1/”）

- ▷ BaseHeight 当前节点区块链的区块高度 （version网络消息的具体用例请参见GitHub ）

5. 版本消息始终是任何对等体发送给另一个对等体的第一条消息。
6. 接收版本消息的本地对等体将**检查远程对等体报告的nVersion**，并确定远端对等体**是否兼容。** 如果远程对等体兼容，则本地对等体将确认版本消息，***并通过发送一个verack建立连接。***
7. 新节点如何找到对等体？  
  

    ==第一种方法是使用多个“DNS种子”来查询DNS，这些DNS服务器提供比特币节点的IP地址列表。==
    
8.  其中一些DNS种子提供了稳定的比特币侦听节点的静态IP地址列表。 一些DNS种子是BIND（Berkeley Internet Name Daemon）的自定义实现，***它从搜索器或长时间运行的比特币节点收集的比特币节点地址列表中返回一个随机子集。*** Bitcoin Core客户端包含五种不同DNS种子的名称。