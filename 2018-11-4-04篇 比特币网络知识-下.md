> 链-比特币  
> 2018年11月04日 15时34分58秒   
> 04 篇  

### 比特币网络(bitcoin network) -下


----------


### 1. 背景
在引入SPV节点/轻量级节点后不久，比特币开发人员就添加了一个新功能：**Bloom过滤器，用以解决SPV节点的隐私风险问题**。Bloom过滤器通过一个采用概率而不是固定模式的过滤机制，**允许SPV节点只接收交易信息的子集，同时不会精确泄露哪些是它们感兴趣的地址。**


----------
### 2. Bloom过滤器
1. Bloom过滤器是一个允许用户描述特定的关键词组合而不必精确表述的基于概率的过滤方法。
2. 它能让用户在有效搜索关键词的同时保护他们的隐私。在SPV节点里，这一方法被用来向对等节点发送交易信息查询请求，同时交易地址不会被 暴露。
3. 用我们之前的例子，一位手中没有地图的游客需要询问去特定地方的路线。如果他向陌生人询问“教堂街23号在哪里”， 不经意之间，他就暴露了自己的目的地。Bloom过滤器则会这样问，附近有带‘堂’字的街道吗？”这样的问法包含了比之前略少的关键词。这位游客可以自己选择包含信息的多少，比如“以‘堂街’结尾”或者“‘教’字开头的街道”。如果他问得越少，得到了更多可能的地址，隐私得到了保护，但这些地址里面不乏无关的结果；如果他问得非常具体，他在得到较准确的结果的同时也暴露了自己的隐私。
4. Bloom过滤器可以让SPV节点指定交易的搜索模式，该搜索模式可以基于准确性或私密性的考虑被调节。一个非常具体 的Bloom过滤器会生成更准确的结果，但也会显示该用户钱包里的使用的地址；反之，如果过滤器只包含简单的关键 词，更多相应的交易会被搜索出来，在包含若干无关交易的同时有着更高的私密性。
举例：我喜欢一个173的女孩。


----------
### 3. Bloom过滤器如何工作
1. Bloom过滤器的实现是由一个可变长度（N）的二进制数组（N位二进制数构成一个位域）和数量可变（M）的一组哈希函数组成。
2. 这些哈希函数的输出值始终在1和N之间，该数值与二进制数组相对应。并且该函数为确定性函数，也就是说任何一个使用相同Bloom过滤器的节点通过该函数都能对特定输入得到同一个的结果。
3. Bloom过滤器的准确性和私密 性能通过改变长度（N）和哈希函数的数量（M）来调节。

4. 一个简单的Bloom过滤器的例子，有一个16位的字段和三个哈希函数
<img src="https://www.github.com/jixiyu/images3/raw/master/小书匠/1541317534688.png" width="600" hegiht="500" align="center" />  

5. Bloom过滤器数组里的每一个数的初始值为零。关键词被加到Bloom过滤器中之前，会依次通过每一个哈希函数运算一 次。该输入经第一个哈希函数运算后得到了一个在1和N之间的数，它在该数组（编号依次为1至N）中所对应的位被置为1，从而把哈希函数的输出记录下来。接着再进行下一个哈希函数的运算，把另外一位置为1；以此类推。当全部M个哈希函数都运算过之后，一共有M个位的值从0变成了1，这个关键词也被“记录”在了Bloom过滤器里。
6. 显示了向图8-8里的简易Bloom过滤器添加关键词“A”。
<img src="https://www.github.com/jixiyu/images3/raw/master/小书匠/1541317714097.png" width="600" hegiht="500" align="center" />  

7. 需要注意的是，当Bloom过滤器里的关键词增加时，它对应的某个哈希函数的输出值的位可能已经 是1了，这种情况下，该位不会再次改变。
8. 也就是说，随着更多的关键词指向了重复的位，Bloom过滤器随着位1的增加 而饱和，准确性也因此降低了。该过滤器之所以是基于概率的数据结构，就是因为关键词的增加会导致准确性的降低。
9.  **准确性取决于关键字的数量以及数组大小（N）和哈希函数的多少（M）**。更大的数组和更多的哈希函数会记录更多的 关键词以提高准确性。而小的数组及有限的哈希函数只能记录有限的关键词从而降低准确性。
10. 显示了向该简易Bloom过滤器里增加第二个关键词“B”。
<img src="https://www.github.com/jixiyu/images3/raw/master/小书匠/1541317849169.png" width="600" hegiht="500" align="center" />  
11. 为测试某一关键词是否被记录在某个Bloom过滤器中，我们将该关键词逐一代入各哈希函数中运算，并将所得的结果与原数组进行对比。如果所有的结果对应的位都变为了1，则表示这个关键词有可能已被该过滤器记录。**之所以这一结论并不确定，是因为这些字节1也有可能是其他关键词运算的重叠结果。简单来说，Bloom过滤器正匹配代表着“可能是”。**
12. 验证关键词“X”是否在前述Bloom过滤器中的图例。相应的比特位都被置为1，所以这个关键词很有可能是匹配的。
<img src="https://www.github.com/jixiyu/images3/raw/master/小书匠/1541317988782.png" width="600" hegiht="500" align="center" /> 
13. 另一方面，如果我们代入关键词计算后的结果某位为0，说明该关键词并没有被记录在过滤器里。负匹配的结果不是可 能，而是一定。也就是说，负匹配代表着“一定不是”。
14. 验证关键词“Y”是否存在于简易Bloom过滤器中的图例。图中某个结果字段为0，该字段一定没有被匹配。
<img src="https://www.github.com/jixiyu/images3/raw/master/小书匠/1541318058006.png" width="600" hegiht="500" align="center" /> 


----------
### 4. SPV节点如何使用Bloom过滤器
1. Bloom过滤器**用于过滤SPV节点从其对等体接收的交易（和包含它们的块）**，仅选择SPV节点感兴趣的交易，而不会泄露其感兴趣的地址或密钥。
2. SPV节点将**初始化“过滤器”为“空”**;在该状态下，bloom过滤器将不匹配任何模式。然后，SPV节点将列出所有感兴趣的地址，密钥和散列，它将通过从其钱包控制的任何UTXO中提取公钥哈希和脚本哈希和交易ID来实现。
3. SPV节点然后将其中的每一个添加到Bloom过滤器，以便如果这些模式存在于交易中，则Bloom过滤器将“匹配”，而不会自动显示模式。
4. 然后，SPV节点将向对等体发送一个过滤器加载消息，其中包含在连接上使用的bloom过滤器。在对等体上，针对每个传入交易检查Bloom过滤器。完整节点根据bloom过滤器检查交易的几个部分，寻找匹配，包括：
5. 交易ID 每个交易输出的锁定脚本的数据组件（脚本中的每个键和哈希） 每个交易输入 每个输入签名数据组件（或见证脚本）
6. 通过检查所有这些组件，可以使用Bloom过滤器来匹配公钥哈希，脚本，OP_RETURN值，签名中的公钥或智能合同或复杂脚本的任何未来组件。
7. 在建立过滤器之后，对等体然后将针对bloom过滤器测试每个交易的输出。只有与过滤器匹配的交易才会发送到节点。

        重要
8. 响应于来自节点的getdata消息，**对等体将发送一个merkleblock消息，该消息仅包含与过滤器匹配的块和每个匹配交易的merkle路径（参见[merkle_trees]）的块头**。**然后，对等体还将发送包含由过滤器匹配的交易的tx消息。**
9. 由于完整节点向SPV节点发送交易，SPV节点丢弃任何误报，并使用正确匹配的交易来更新其UTXO集和钱包余额。随着它更新自己的UTXO集视图，它还会修改bloom过滤器，以匹配任何引用其刚刚发现的UTXO的交易。然后，完整节点使用新的bloom过滤器来匹配新交易，并重复整个过程。
10. 设置bloom过滤器的节点可以通过发送filteradd消息将模式交互式添加到过滤器。要清除bloom过滤器，节点可以发送一个过滤清除消息。因为不可能从布局过滤器中删除模式，所以如果不再需要模式，则节点必须清除并重新发送新的布隆过滤器。


----------
### 5. SPV节点和隐私
1. bloom过滤器是减少隐私损失的一种方式。没有它们，SPV节点将不得不明确地列出它感兴趣的地址，造成严重的隐私违规。然而，即使使用过滤器，对手监控SPV客户端的流量或直接连接到它的P2P网络中的节点可以随时随地收集足够的信息来了解SPV客户端的钱包中的地址。


----------
### 6. 加密和认证连接
1. 比特币的大多数新用户假设比特币节点的网络通信是加密的。其实，比特币的原始实现就很明显地完成了。虽然这不是完整节点的主要隐私问题，但SPV节点是一个很大的问题。

作为增加比特币P2P网络隐私和安全性的一种方法，有两种解决方案可以通过BIP-150/151提供通信加密：Tor传输和P2P认证和加密。


----------
### 7.Tor运输
Tor代表洋葱路由网络，是一个软件项目和网络，通过提供匿名，不可追踪和隐私的随机网络路径提供数据的加密和封装。

Bitcoin Core提供了多种配置选项，允许您运行通过Tor网络传输的流量的比特币节点。此外，Bitcoin Core还可以提供Tor隐藏服务，允许其他Tor节点通过Tor直接连接到您的节点。

从Bitcoin Core版本0.12开始，如果能够连接到本地Tor服务，节点将自动提供隐藏的Tor服务。如果您安装Tor并且Bitcoin Core进程作为具有足够权限的用户访问Tor认证cookie的用户运行，则应自动运行。使用debug标志打开Bitcoin Core对于Tor服务的调试，如下所示：

```
$ bitcoind --daemon --debug=tor
```

你应该在日志中看到“tor：ADD_ONION success”，表示Bitcoin Core已经向Tor网络添加了隐藏的服务。

您可以在Bitcoin Core文档（docs / tor.md）和各种在线教程中找到有关运行Bitcoin Core作为Tor隐藏服务的更多说明。


----------
### 8. 交易池
比特币网络中几乎每个节点都会维护一份未确认交易的临时列表，被称为内存池或交易池。节点们利用这个池来追踪记录那些被网络所知晓、但还未被区块链所包含的交易。例如，保存用户钱包的节点会利用这个交易池来记录那些网络已经接收但还未被确认的、属于该用户钱包的预支付信息。

随着交易被接收和验证，它们被添加到交易池并通知到相邻节点处，从而传播到网络中。

有些节点的实现还维护一个单独的孤立交易池。如果一个交易的输入与某未知的交易有关，如与缺失的父交易相关，该 孤立交易就会被暂时储存在孤立交易池中直到父交易的信息到达。

当一个交易被添加到交易池中，会同时检查孤立交易池，看是否有某个孤立交易引用了此交易的输出（子交易）。任何 匹配的孤立交易会被进行验证。如果验证有效，它们会从孤立交易池中删除，并添加到交易池中，使以其父交易开始的链变得完整。对新加入交易池的交易来说，它不再是孤立交易。前述过程重复递归寻找进一步的后代，直至所有的后代都被找到。通过这一过程，一个父交易的到达把整条链中的孤立交易和它们的父级交易重新结合在一起，从而触发了整 条独立交易链进行级联重构。

交易池和孤立交易池（如有实施）都是存储在本地内存中，并不是存储在永久性存储设备（如硬盘）里。更准确的说， 它们是随网络传入的消息动态填充的。节点启动时，两个池都是空闲的；随着网络中新交易不断被接收，两个池逐渐被 填充。

有些比特币客户端的实现还维护一个UTXO数据库，也称UTXO池，是区块链中所有未支付交易输出的集合。“UTXO 池”的名字听上去与交易池相似，但它代表了不同的数据集。UTXO池不同于交易池和孤立交易池的地方在于，它在初始 化时不为空，而是包含了数以百万计的未支付交易输出条目，有些条目的历史甚至可以追溯至2009年。UTXO池可能会被安置在本地内存，或者作为一个包含索引的数据库表安置在永久性存储设备中。

交易池和孤立交易池代表的是单个节点的本地视角。取决于节点的启动时间或重启时间，不同节点的两池内容可能有很 大差别。相反地，UTXO池代表的是网络的突显共识，因此，不同节点间UTXO池的内容差别不大。此外，交易池和孤立交易池只包含未确认交易，而UTXO池之只包含已确认交易。

